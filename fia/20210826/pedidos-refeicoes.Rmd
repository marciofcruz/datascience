---
title: "Pedidos de Refeições"
author: "Marcio Cruz"
date: "31/08/2021"
output: html_document
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=20, fig.height=10, fig.align = "center") 

wd <- Sys.getenv("RWD")

if (!file.exists(wd)) {
  stop(paste("O diretorio definido na variavel de ambiente RWD nao foi encontrado",wd, sep="="))
} 

setwd(wd)
getwd()

rm(list = ls())

options(scipen=999)
options(width = 1024)

library(Metrics)
library(MLmetrics)
library("stringi")
library(knitr)
library(InformationValue)
library(moments)
library(pander)
library(dplyr)
library(cutpointr)
library(Information)
library(readxl) #Avisar o R que utilizará este pacote. Deve-se avisar toda vez que abrir o R
library(HH)
library(expss)
library(arules)
library(smbinning)
library(scorecard)
library(ggplot2)
library(ggpubr)
library(readxl)
library(caret)
library(e1071)

library("gtools")
library("partykit")
library("CHAID")


theme_set(theme_pubr())

```

# Case
Uma empresa de tecnologia, atuante no ramo de entrega de refeições solicitadas online, gostaria de entender quais os perfis de consumidores que mais se deixam influenciar pela nota de avaliação dos restaurantes parceiros, no momento de realizarem seu pedido. Para entender esse aspecto, realizaram uma pesquisa com 2.744 clientes que fizeram algum pedido nos últimos 30 dias.

Fonte: Kaggle (adaptado)
Link: https://www.kaggle.com/benroshan/online-food-delivery-preferencesbangalore-region


```{r echo = F}
refeicoes <- read_excel("doc/Pedidos_Refeicoes.xlsx", sheet="Base de Dados")

# Transformar variaveis em fator
refeicoes[sapply(refeicoes, is.character)] <- lapply(refeicoes[sapply(refeicoes, is.character)], as.factor)


```

## a) Faça a análise exploratória de cada variável, individualmente.
```{r echo = F}
sapply(refeicoes, class) # Visao geral dos tipos

# summary(refeicoes$Idade)

kable(round(prop.table(table(refeicoes$Genero)),3), caption = "Gênero")
kable(round(prop.table(table(refeicoes$Estado_civil)),3), caption = "Estado Civil")
kable(round(prop.table(table(refeicoes$Ocupacao)),3), caption = "Ocupação")
kable(round(prop.table(table(refeicoes$Renda_mensal)),3), caption = "Renda Mensal")
kable(round(prop.table(table(refeicoes$Grau_educacao)),3), caption = "Grau Educação")
kable(round(prop.table(table(refeicoes$Refeicao_mais_frequente)),3), caption = "Refeição mais Frequente")
kable(round(prop.table(table(refeicoes$Compras_saudaveis)),3), caption = "Compras Saudáveis")
kable(round(prop.table(table(refeicoes$Reclamacao_atraso)),3), caption = "Reclamação Atraso")
kable(round(prop.table(table(refeicoes$Avaliacao_media_anterior)),3), caption = "Avaliação Média Anterior")
kable(round(prop.table(table(refeicoes$Influenciado_por_nota)),3), caption ="Influenciado por Nota")


```


## b) Categorize as variaveis quantitativas, a fim de utiliza-las na arvore de decisao.
```{r echo}
refeicoes$Idade_cat <- quantcut(refeicoes$Idade, 4)

```

## c) Faca a analise bidimensional de cada variavel explicativa versus a variavel resposta.
### Quais variáveis parecem exercer maior influência sobre a resposta?
```{r echo = F}
kable(round(prop.table(table(refeicoes$Idade_cat, refeicoes$Influenciado_por_nota), 1), 3), caption = "Idade Categoria x Nota")
kable(round(prop.table(table(refeicoes$Genero, refeicoes$Influenciado_por_nota), 1), 3), caption = "Genero x Nota")
kable(round(prop.table(table(refeicoes$Estado_civil, refeicoes$Influenciado_por_nota), 1), 3), caption = "Estado Civil x Nota")
kable(round(prop.table(table(refeicoes$Ocupacao, refeicoes$Influenciado_por_nota), 1), 3), caption  = "Ocupação x Nota")
kable(round(prop.table(table(refeicoes$Renda_mensal, refeicoes$Influenciado_por_nota), 1), 3), caption = "Renda Mensal x Nota")
kable(round(prop.table(table(refeicoes$Grau_educacao, refeicoes$Influenciado_por_nota), 1), 3), caption = "Grau Educação x Nota")
kable(round(prop.table(table(refeicoes$Refeicao_mais_frequente, refeicoes$Influenciado_por_nota), 1), 3), caption = "Refeiçào mais frequente x Nota")
kable(round(prop.table(table(refeicoes$Compras_saudaveis, refeicoes$Influenciado_por_nota), 1), 3), caption = "Compras Saudáveis x Nota")
kable(round(prop.table(table(refeicoes$Reclamacao_atraso, refeicoes$Influenciado_por_nota), 1), 3), caption = "Reclamação Atraso x Nota")
kable(round(prop.table(table(refeicoes$Avaliacao_media_anterior, refeicoes$Influenciado_por_nota), 1), 3), caption = "Avaliação Média Anterior x Nota")

```

### Criar arvore de decisao de 2 niveis, de acordo com o algoritmo CHAID
```{r}
controle <- chaid_control(maxheight = 2)

arvore_2niveis <- chaid(Influenciado_por_nota ~
                        Idade_cat +
                        Genero +
                        Estado_civil +
                        Ocupacao +
                        Renda_mensal +
                        Grau_educacao +
                        Refeicao_mais_frequente +
                        Compras_saudaveis +
                        Reclamacao_atraso +
                        Avaliacao_media_anterior,
                      data = refeicoes,
                      control = controle)

```

## d) Ha quantos nos intermediarios e nos finais?
```{r echo = F}
plot(arvore_2niveis, gp = gpar(cex = 0.8))

```

## e) Qual a frequencia absoluta e relativa de cada no final?
```{r echo = F}
refeicoes$no_2niveis <- predict(arvore_2niveis, refeicoes, type = "node")

rbind(table(refeicoes$no_2niveis), round(prop.table(table(refeicoes$no_2niveis)), 3))

```

## f) Quantos nos finais sao mais propensos que a base geral a se deixarem influenciar pela nota?
```{r}
(prob_geral = sum(refeicoes$Influenciado_por_nota == "Sim") / nrow(refeicoes))
round(prop.table(table(refeicoes$no_2niveis, refeicoes$Influenciado_por_nota), 1), 3)

```

## g) Interprete todos os perfis obtidos, do mais propenso ao menos propenso.


## h) Avalie o desempenho do modelo, por meio dos índices de sensibilidade, especificidade e acurácia.
```{r}
refeicoes$prob_2niveis <- predict(arvore_2niveis, refeicoes, type = "p")[,2]
refeicoes$predito_2niveis <- ifelse(refeicoes$prob_2niveis >= prob_geral, "Sim", "Não")

round(prop.table(table(refeicoes$Influenciado_por_nota, refeicoes$predito_2niveis)), 3)
round(prop.table(table(refeicoes$Influenciado_por_nota, refeicoes$predito_2niveis), 1), 3)

```

### Construa uma nova Árvore de Decisão, agora com 3 níveis*.
```{r echo = F}
controle <- chaid_control(maxheight = 3,
                          minsplit = 200,
                          minprob = 1,
                          minbucket = 100)

arvore_3niveis <- chaid(Influenciado_por_nota ~
                        Idade_cat +
                        Genero +
                        Estado_civil +
                        Ocupacao +
                        Renda_mensal +
                        Grau_educacao +
                        Refeicao_mais_frequente +
                        Compras_saudaveis +
                        Reclamacao_atraso +
                        Avaliacao_media_anterior,
                      data = refeicoes,
                      control = controle)

```

### Ha quantos nos intermediarios e nos finais?
```{r}

plot(arvore_3niveis, gp = gpar(cex = 0.7), main = "Arvore com 3 niveis")
```

### Qual a frequencia absoluta e relativa de cada no final?
```{r echo = F}
refeicoes$no_3niveis <- predict(arvore_3niveis, refeicoes, type = "node")

rbind(table(refeicoes$no_3niveis), round(prop.table(table(refeicoes$no_3niveis)), 3))

```

### Quantos nos finais sao mais propensos que a base geral a se deixarem influenciar pela nota?
```{r}
(prob_geral = sum(refeicoes$Influenciado_por_nota == "Sim") / nrow(refeicoes))
round(prop.table(table(refeicoes$no_3niveis, refeicoes$Influenciado_por_nota), 1), 3)

```
### Avalie o desempenho do modelo, por meio dos índices de sensibilidade, especificidade e acurácia.
```{r}
refeicoes$prob_3niveis <- predict(arvore_3niveis, refeicoes, type = "p")[,2]
refeicoes$predito_3niveis <- ifelse(refeicoes$prob_3niveis >= prob_geral, "Sim", "Não")

round(prop.table(table(refeicoes$Influenciado_por_nota, refeicoes$predito_3niveis)), 3)
round(prop.table(table(refeicoes$Influenciado_por_nota, refeicoes$predito_3niveis), 1), 3)

```

## j) Compare os desempenhos de ambos os modelos, com 2 níveis e com 3 níveis. Qual dos dois você escolheria para explicar o comportamento dos consumidores?
```{r}
# resultado1 <- confusionMatrix(actuals =  as.factor(refeicoes$Influenciado_por_nota), predictedScores = as.factor(refeicoes$prob_2niveis), data = refeicoes, )
# resultado2 <- confusionMatrix(as.factor(refeicoes$Influenciado_por_nota), as.factor(refeicoes$prob_3niveis))
resultado1 <- confusionMatrix(as.factor(refeicoes$Influenciado_por_nota),as.factor(refeicoes$predito_2niveis),positive='Sim')
resultado2 <- confusionMatrix(as.factor(refeicoes$Influenciado_por_nota),as.factor(refeicoes$predito_3niveis),positive='Sim')

resultado1$overall[1]
resultado2$overall[1]
```


