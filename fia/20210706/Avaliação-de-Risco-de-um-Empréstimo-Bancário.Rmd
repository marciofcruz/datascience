---
title: "Avaliação Risco de Empréstimo Bancário"
author: "Marcio Cruz"
date: "10/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# inicialização -----------------------------------------------------------
wd <- Sys.getenv("RWD")

if (!file.exists(wd)) {
  stop(paste("O diretorio definido na variavel de ambiente RWD nao foi encontrado",wd, sep="="))
} 

setwd(wd)
getwd()

rm(list = ls())

options(scipen=999)

library(Metrics)
library(knitr)
library(moments)
library(pander)
library(dplyr)
library(readxl) #Avisar o R que utilizará este pacote. Deve-se avisar toda vez que abrir o R

```

```{r echo = F}

calcula_correlacao <- function(df_dados, variaveis, corte) {
  df <- data.frame(variavel1 = NULL, variavel2 = NULL, correlacao = NULL)
  
  for (var1 in variaveis) {
    for (var2 in variaveis) {
      if (var1 != var2) {
        correlacao_auxiliar <- cor(df_dados[,var1], df_dados[,var2])
        correlacao_auxiliar <- correlacao_auxiliar[1]
        
        if (correlacao_auxiliar >= corte | correlacao_auxiliar <= (-1*corte)) {
          
          achou <- length(df$correlacao[df$variavel1 == var2 & df$variavel2 == var1]) > 0
          
          if (!achou) {
            linha <- data.frame(variavel1 = var1, variavel2 = var2, correlacao = correlacao_auxiliar)
            df <- rbind(df, linha)
          }
        }
      }
    }
  }
  
  return(df)
  
}

calcula_discrepantes <- function(empbanc)  {
  vars <- names(empbanc)[1:7]
  df <- data.frame(variavel = NULL, li = NULL, ls = NULL, missing = NULL, outlier_menor = NULL, outlier_maior = NULL) 
  
  for(i in vars) {
    auxiliar <- empbanc[,i]
    colnames(auxiliar)[1] <- "valor"
    
    aeq.q1 <- quantile(auxiliar$valor, 0.25)
    aeq.q3 <- quantile(auxiliar$valor, 0.75)
    aeq.iiq <- aeq.q3- aeq.q1
    aeq.li <- aeq.q1 - 1.5 * aeq.iiq
    aeq.ls <- aeq.q3 + 1.5 * aeq.iiq
    aeq.media <- mean(auxiliar$valor)
    aeq.mediana <- median(auxiliar$valor)
    aeq.coeficiente_assimetria <- skewness(auxiliar$valor)
    aeq.missing <- dim(empbanc[is.na(i),])[1]
    
    linha <- data.frame(variavel = i, 
                        li = aeq.li, 
                        ls = aeq.ls, 
                        missing = aeq.missing, 
                        outlier_menor = length(auxiliar$valor[auxiliar$valor < aeq.li]),
                        outlier_maior = length(auxiliar$valor[auxiliar$valor > aeq.ls]))
    df <- rbind(df, linha)
  }
  
  return(df)
}
```


## Case
Considere dados históricos provenientes de um banco de varejo, referentes a 5.000 propostas de crédito geradas durante solicitações de empréstimo. A base traz informações como idade, nível de instrução, tempo de experiência, tempo no endereço e renda; além da variável resposta “classif” (0=bom pagador, 1=mau pagador). Deseja-se avaliar o potencial dessas variáveis para predizer se um cliente será um bom ou mau pagador.

```{r echo = F}

empbanc <- read_excel("base1/Emprestimo_Bancario.xlsx", sheet = "Base de Dados")

total.antes <-dim(empbanc)[1]
```

## a) Faça a análise exploratória univariada e interprete todas as variáveis do banco de dados.
```{r echo = F}
summary(empbanc)
vars <- names(empbanc)[1:7]

par(mfrow = c(2, 4))
for(i in vars) {
  auxiliar <- empbanc[,i]
  boxplot(auxiliar, main=paste0("", i), col="orange")
}


```

Todas as variáveis são quantitativas contínuas e, analisando graficamente apenas a idade não apresenta outlier. Podemos observar também que valores monetários possuem uma amplitude muito alta, que indica fortemente que a outlieres a maior destes números.


## b) Há algum outlier que mereça atenção? E com relação a dados faltantes?

### Primeira Análise
```{r echo = F}
df <- calcula_discrepantes(empbanc)
kable(df, caption="Análise Inicial do Banco")

# dim(teste <- empbanc[empbanc$renda > 100.0625,])[1]
```
#### Missing: 
Nenhuma variável nesta situação

#### Visão sobre os Outlier:
##### Experiêcia e Tempo endereço: possuem valores discrepantes do ponto de vista estatístico mas, analisando o boxplot e os valores descritivos, concluo que são normais do ponto de vista de negócio.
##### Variáveis explicativas monetárias: Todas apresentam outlier mas, começaremos a análise pela Renda, até não ter mais outlier desta variável.

#### Outlier de Renda:
```{r echo = F}

ls <- df$ls[df$variavel == "renda"]
outlier_maior <- df$outlier_maior[df$variavel == "renda"]

total_reducoes <- 0

while (outlier_maior > 0) {
  df <- calcula_discrepantes(empbanc)
  outlier_maior <- df$outlier_maior[df$variavel == "renda"]

  ls <- df$ls[df$variavel == "renda"]
  
  empbanc <- empbanc[empbanc$renda <= ls,]
  total_reducoes <- total_reducoes + 1
}

total.depois <-dim(empbanc)[1]

kable(df, caption = paste("Retirado os outliers de Renda em ", total_reducoes, "passo(s).", "Observações a serem analisadas:", total.depois))
summary(empbanc)
```

Na análise inicial, identificou-se que há 392 registros que possuem renda anual em salário mínimos discrepantes.

#### Outros outliers:
Estatisticamente ainda observamos outliers no quadro abaixo, porém, parecem ser valores dentro do contexto do negócio.

## c) Qual o % de empréstimos não pagos (ou “% de maus”, ou “% de default”)?
```{r echo = F }
proporcao <- prop.table(table(empbanc$classif))
proporcao.bom_pagador <- proporcao[1]*100
proporcao.mau_pagador <- proporcao[2]*100
```

O percentual de bons pagadores é `r format(round(proporcao.bom_pagador, 4), nsmall = 4)`%, em contrapartida, há `r format(round(proporcao.mau_pagador, 4), nsmall = 4)`% de maus pagadores.

## d) Qual a correlação entre as variáveis presentes na base?
```{r echo = FALSE}

kable(cor(empbanc[1:7]))

correlacao_entre_variaveis <- calcula_correlacao(empbanc, names(empbanc)[1:7], 0.7)
kable(correlacao_entre_variaveis, caption="Variáveis que não podem estar no mesmo modelo devido a multicolinearidade")
```

### e) Quais são as variáveis que melhor explicam se o empréstimo foi pago ou não?
```{r echo = F}
par(mfrow = c(2, 4))
boxplot(empbanc$idade ~empbanc$classif, col = "darkturquoise", main = "idade", xlab="0-Bom 1-Mau")
boxplot(empbanc$experiencia ~empbanc$classif, col = "darkturquoise", main = "experiencia", xlab="0-Bom 1-Mau")
boxplot(empbanc$tempo_endereco ~empbanc$classif, col = "darkturquoise", main = "tempo endereco", xlab="0-Bom 1-Mau")
boxplot(empbanc$renda ~empbanc$classif, col = "darkturquoise", main = "renda", xlab="0-Bom 1-Mau")
boxplot(empbanc$debito_renda ~empbanc$classif, col = "darkturquoise", main = "debito renda", xlab="0-Bom 1-Mau")
boxplot(empbanc$cred_deb ~empbanc$classif, col = "darkturquoise", main = "credito debito", xlab="0-Bom 1-Mau")
boxplot(empbanc$outros_debitos ~empbanc$classif, col = "darkturquoise", main = "outros debitos", xlab="0-Bom 1-Mau")

```
De acordo com a análise gráfica, quem é mais velho, quem tem maior tempo de experiência, maior tempo de endereço, renda maior são fatores que 
influenciam um cliente ser um bom pagador.
Porém, se o cliente possuir outros débitos, se a razão o que ele ganha e gasta for alta, influencia a ser um mau pagador.

### f) Ajuste um modelo logístico e avalie quais variáveis apareceram como significantes. Adote 10% de significância.

#### Abordagem com a variável relação débito e renda total
```{r echo = F}
modelo <- glm(classif ~
                idade +
                experiencia +
                tempo_endereco +
                renda +
                cred_deb +
                debito_renda, 
              family = binomial(link = 'logit'), data = empbanc)
summary(modelo)

modelo <- glm(classif ~
                experiencia +
                tempo_endereco +
                renda +
                cred_deb +
                debito_renda, 
              family = binomial(link = 'logit'), data = empbanc)
summary(modelo)

modelo.a <- glm(classif ~
                experiencia +
                tempo_endereco +
                cred_deb +
                debito_renda, 
              family = binomial(link = 'logit'), data = empbanc)
summary(modelo.a)
```

#### Abordagem com a variável outros débitos
```{r echo = F}
modelo <- glm(classif ~
                idade +
                experiencia +
                tempo_endereco +
                renda +
                cred_deb +
                outros_debitos, 
              family = binomial(link = 'logit'), data = empbanc)
summary(modelo)

modelo.b <- glm(classif ~
                experiencia +
                tempo_endereco +
                renda +
                cred_deb +
                outros_debitos, 
              family = binomial(link = 'logit'), data = empbanc)
summary(modelo.b)
```
O modelo que apresentou melhor desempenho, contendo o menor número de variáveis é o que contém: tempo de experiência em anos,
razão entre os créditos e débitos, e a relação entre as dívidas totais e a renda anual.

### g) Calcule o score de propensão a default como uma coluna nova na base.
```{r echo  = F}
empbanc$score_propensao <- predict(modelo.a, empbanc, type = "response")
kable(head(empbanc), caption = "Score de propensão")
```
### h) Qual a sugestão inicial de ponto de corte para predizer se o empréstimo será pago ou não?
```{r}
empbanc$predito <- as.factor(ifelse(empbanc$score_propensao > 0.5, 1, 0))
```
O valor inicial foi 50%.

### i) Considerando essa sugestão, construa a matriz de confusão. Qual a taxa de classificação correta?
```{r echo = F}
mc.tabela <- table(empbanc$classif, empbanc$predito)
kable(mc.tabela, caption="Resposta Observada x Resposta Predita")


mc.vn <- mc.tabela[1,1]
mc.vp <- mc.tabela[2,2]
mc.fn <- mc.tabela[2,1]
mc.fp <- mc.tabela[1,2]

mc.acuracia <- (mc.vp + mc.vn)/ (mc.vp + mc.vn + mc.fn + mc.fp)
mc.sensibilidade <- mc.vp / (mc.vp + mc.fn)
mc.especificidade <- mc.vn / (mc.vn + mc.fp)
```

#### Diagonais:
##### Diagonal Principal:`r format(round(mc.vn + mc.vp, 4), nsmall = 4)`  
##### Diagonal Secundária:`r format(round(mc.fp + mc.fn, 4), nsmall = 4)`  
##### Proporção: `r format(round((mc.vn + mc.vp) / (mc.fp + mc.fn), 4), nsmall = 4)`


#### Índices:
##### Acurácia (vp+vn / vp+vn+fp+fn):  `r format(round(mc.acuracia, 4), nsmall = 4)`
##### Sensibilidade (vp/vp+fn):  `r format(round(mc.sensibilidade, 4), nsmall = 4)`
##### Especificidade (vn/vn+fp):  `r format(round(mc.especificidade, 4), nsmall = 4)`

### Interpretação sobre o modelo
#### Apresenta bom ajuste, já que há concentração dos casos na diagonal principal, confirmado pela acurácia de: `r format(round(mc.acuracia*100, 2), nsmall = 2)`%
#### Sendo que o objetivo do modelo é descobrir quem seja um mau pagador, usaremos a referência do indicador de sensibilidade: `r format(round(mc.sensibilidade*100, 2), nsmall = 2)`%. 654 classificados com mau pagadores, foram classificados incorretamente e, 454 classificados como mau pagadores, foram classificados corretamente.
#### O resultado do índice de sensibilidade  demonstra um ajuste regular do modelo.
