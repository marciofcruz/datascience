---
title: "Otimização da Categorização HR Analytics"
author: "Marcio Cruz"
date: "13/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# inicialização -----------------------------------------------------------
wd <- Sys.getenv("RWD")

if (!file.exists(wd)) {
  stop(paste("O diretorio definido na variavel de ambiente RWD nao foi encontrado",wd, sep="="))
} 

setwd(wd)
getwd()

rm(list = ls())

options(scipen=999)

# install.packages("dgof")
library(dgof)

library(Metrics)
# install.packages("MLmetrics")
library(MLmetrics)
library(knitr)
#install.packages("InformationValue")
library(InformationValue)
library(moments)
library(pander)
library(dplyr)
library(cutpointr)
library(Information)
library(readxl) #Avisar o R que utilizará este pacote. Deve-se avisar toda vez que abrir o R
library(HH)
# install.packages("smbinning")
library(smbinning)

```

## Case
Na pasta "BASE_DADOS", estão disponíveis 14.999 registros de informações sobre funcionários de uma empresa. 
Seja left o evento de interesse (1=sim, 0=não), que indica se o funcionário saiu ou não da empresa. Nosso interesse é, a partir das variáveis explicativas  a seguir, tentar explicar o evento “saída da empresa”:


```{r echo = F}
rh<-read_excel("base/OTIMIZACAO_CATEGORIAS_ HR_ANALYTICS.xlsx", sheet="BASE_DADOS")

# Conversao da base para o formato dataframe 
rh <- as.data.frame(rh)
# class(rh)
```
### Otimização do Satisfaction Level
```{r echo = F}
#Conversao de variaveis para numericas
rh$satisfaction_level<-as.numeric(rh$satisfaction_level)

#Calculo do IV das variaveis (sem otimizacao)
IV_antes <- create_infotables(data = rh, y = "left", ncore = 2)
IV_antes$Summary
antes <- IV_antes$Summary[IV_antes$Summary$Variable == "satisfaction_level","IV"]

# Categorizacao otima da variavel "satisfaction level"
satlevel_optbin <- smbinning(df=rh,y="left",x="satisfaction_level",p=0.08) 
satlevel_optbin$ivtable

#Salvar a variavel categorizada na base
rh <- smbinning.gen(rh, satlevel_optbin, chrname="satlevel_opt" )

#Calcular novamente IV das variaveis da base
IV_depois <- create_infotables(data = rh, y = "left", ncore = 2)
# IV_depois$Summary
depois <- IV_depois$Summary[IV_depois$Summary$Variable == "satlevel_opt","IV"]
```

##### IV Antes:  `r format(round(antes, 4), nsmall = 4)`
##### IV Depois:  `r format(round(depois, 4), nsmall = 4)`
##### Melhoria:  `r format(round(((depois-antes)/antes*100) , 4), nsmall = 4)`%

### Otimização do Last Evaluation
```{r echo = F}
rh$last_evaluation <-as.numeric(rh$last_evaluation)

IV_antes <- create_infotables(data = rh, y = "left", ncore = 2)
# IV_antes$Summary
antes <- IV_antes$Summary[IV_antes$Summary$Variable == "last_evaluation", "IV"]

# Categorizacao otima
lasteval_optbin <- smbinning(df=rh,y="left",x="last_evaluation", p=0.3) 
# lasteval_optbin

#rh <- smbinning.gen(rh, lasteval_optbin, chrname="last_evaluation_opt" )

#Calcular novamente IV das variaveis da base
#IV_depois <- create_infotables(data = rh, y = "left", ncore = 2)
#depois <- IV_depois$Summary[IV_depois$Summary$Variable == "last_evaluation_opt","IV"]

```
***Não foi possível otimizar a Variável : No Significant Splits***


### Otimização do Average Montly Hours
```{r echo = F}
rh$average_montly_hours <-as.numeric(rh$average_montly_hours)

IV_antes <- create_infotables(data = rh, y = "left", ncore = 2)
# IV_antes$Summary
antes <- IV_antes$Summary[IV_antes$Summary$Variable == "average_montly_hours", "IV"]

# Categorizacao otima
avaregamh_optbin <- smbinning(df=rh,y="left",x="average_montly_hours", p=0.06) 
avaregamh_optbin$ivtable
avaregamh_optbin$iv

rh <- smbinning.gen(rh, avaregamh_optbin, chrname="average_montly_hours_opt" )

#Calcular novamente IV das variaveis da base
IV_depois <- create_infotables(data = rh, y = "left", ncore = 2)
# IV_depois$Summary
depois <- IV_depois$Summary[IV_depois$Summary$Variable == "average_montly_hours_opt","IV"]

```

##### IV Antes:  `r format(round(antes, 4), nsmall = 4)`
##### IV Depois:  `r format(round(depois, 4), nsmall = 4)`
##### Melhoria:  `r format(round(((depois-antes)/antes*100) , 4), nsmall = 4)`%

### Modelo
```{r}

# names(rh)
modelo.comum <- glm(left  ~
                  satisfaction_level +
                average_montly_hours +
                last_evaluation, 
              family = binomial(link = 'logit'), data = rh)
summary(modelo.comum)
rh$probabilidade_comum = predict(modelo.comum, rh, type = "response")

ks_comum <- ks_stat(actuals = rh$left, predictedScores = rh$probabilidade_comum)


modelo.otimizado <- glm(left  ~
                  satlevel_opt +
                average_montly_hours_opt +
                last_evaluation, 
              family = binomial(link = 'logit'), data = rh)
rh$probabilidade_otimizada = predict(modelo.otimizado, rh, type = "response")
summary(modelo.otimizado)

ks_otimizado <- ks_stat(actuals = rh$left, predictedScores = rh$probabilidade_otimizada)
```


### VIF
```{r echo = F}
vif <- vif(modelo.comum)
kable(vif, caption = "VIF do Modelo Comum")

vif <- vif(modelo.otimizado)
kable(vif, caption = "VIF do Modelo Otimizado")
```

### ROC do Modelo Comum
```{r echo = F}
plotROC(actuals=rh$left, predictedScores=rh$probabilidade_comum, Show.labels = T)
```

### ROC do Modelo Otimizado
```{r echo = F}
plotROC(actuals=rh$left, predictedScores=rh$probabilidade_otimizada, Show.labels = T)
```


##### ***KS sobre o modelo comum:***  `r format(round(ks_comum, 4), nsmall = 4)`
##### ***KS sobre o modelo otimizado:***  `r format(round(ks_otimizado, 4), nsmall = 4)`

### Head da Tabela

```{r echo = F}

kable(head(rh), caption = "Resultado")

```

## Conclusão:

#### Consegui otimizar a categorização das variáveis Satisfaction Level e Average Montly Hours
#### A variável explicativa Last Evaluation deu nenhum corte significativo ("No significant splits")
#### A variável de Nível de Satisfação conseguimos um ajuste de melhora de 8,78%
#### A variável de Média de Horas Mensais ("Average Montly Hours") conseguimos um ajuste de melhora de 10,07%
#### O K-S calculado  sem otimização de categorização traz um valor de 0.5056.
#### O k-S calculado sobre o modelo otimizado traz um valor de 0.7835.
#### É visível a melhora do K-S onde se otimiza a categorização de variáveis explicativas.
