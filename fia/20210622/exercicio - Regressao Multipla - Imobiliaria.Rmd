---
title: "Predição Valor Imóvel"
author: "Marcio Cruz"
date: "29/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

wd <- Sys.getenv("RWD")

if (!file.exists(wd)) {
  stop(paste("O diretorio definido na variavel de ambiente RWD nao foi encontrado",wd, sep="="))
} 

setwd(wd)
getwd()

rm(list = ls())

options(scipen=999)

library(readxl) #Avisar o R que utilizará este pacote. Deve-se avisar toda vez que abrir o R
library(GGally)
library(Metrics)

imobiliario <- read_excel("doc/Regressão linear múltipla.xlsx", sheet="Imobiliario")
```
## Case 
De acordo com a localização de um imóvel, sabe-se que o valor do mesmo pode variar substancialmente. Na base de dados disponibilizada são fornecidas informações sobre o valor do imóvel (R$) por mil m², a distância para estação de metrô (km), a quantidade de comércios próximos e a idade (em anos) do imóvel, em um bairro bem localizado de grande centro urbano. Quais são as características relacionadas ao imóvel que predizem seu valor?



## Respostas
### a) Calcule o coeficiente de correlação entre as variáveis quantitativas do banco de dados. Interprete os coeficientes.
```{r echo = F}
ggpairs(imobiliario, title="Correlograma entre variáveis quantitativas") 
```

**Interpretação:** A explicação do preço do m2 do imóvel tem forte correlação com as variáveis explicativas idade do imóvel, distância ao metrô e quantidade de comércios próximos. Onde, a idade do imóvel e a distância do metrô tem efeito de decrescer o valor do m2, enquanto a quantidade de comércios aumenta o valor.

### b) Realize a análise bidimensional entre as covariáveis existentes e investigue possíveis problemas de multicolinearidade.
Não existe o problema de colinearidade entre as variáveis da base.

### c) Obtenha o modelo de regressão linear múltipla, considerando um nível de significância de 5% para seleção de variáveis.
```{r}
regressao.1 <- lm(data=imobiliario, imobiliario$Mil_reais_m2 ~ imobiliario$Idade_imovel + imobiliario$Distancia_metro_Km + imobiliario$Comercios_proximos)
summary(regressao.1)
```

### d) Interprete os parâmetros do modelo e o coeficiente de determinação.
#### -0.041448 é a redução do preço do m2 para cada unidade de aumento da idade de imóvel, mantendo as outras variáveis zeradas.
#### 5.739872 é o aumento do preço do m2 para cada unidade de aumento da distância ao metrô, mantendo as outras variáveis zeradas.
#### 0.183508 é o aumento do preço do m2 para cada unidade de aumento da quantidade de comércios próximos, manteno as outras variáveis zeradas.
#### 61,69% do preço do m2 é explicado pelas variáveis Idade do Imóvel, distância deste ao metrô e quantidade de comércios próximos.

### e) Apresente a equação do modelo estimado.
y_estimado <- 16.493840 + (-0.04144 * idade) + (-5.739872 * distanciametro) + (0.183508 * qtdecomercios)

### f) Caso um comprador esteja procurando um imóvel a 1 km do metrô, com 5 comércios próximos e que tenha 5 anos, qual valor médio ele pagaria em um imóvel de 85 m2?
```{r}
idade <- 5
distanciametro <- 1
qtdecomercios <- 5
y_estimado <- (16.493840 + (-0.04144 * idade) + (-5.739872*distanciametro) + (0.183508*qtdecomercios)) 
valor_estimado <- 85 * y_estimado * 1000
```
#### O valor do imóvel é R$ `r format(round(valor_estimado, 2), nsmall = 2)`


## Análise de Erro
### Gráficos para verificar Normalidade dos Resíduos
```{r}
residuo <- residuals(regressao.1) # fornece os residuos do modelo
predito <- fitted.values(regressao.1) # fornece os preditos do modelo

par(mfrow = c(1,3))
hist(residuo, col = "darkturquoise")
# Graficos para verificar normalidade dos residuos
qqnorm(residuo, pch = 1, col = "darkturquoise", frame = FALSE)
qqline(residuo, col = "steelblue", lwd = 2)
```

### Verificar resíduo atípico
```{r}
# Imobiliario$residuo <- residuals(regressao) 
# Imobiliario$predito <- fitted.values(regressao) 
# res <- subset(Imobiliario,Imobiliario$residuo <- 5)
```

### Analisar a linearidade
```{r}
par(mfrow = c(1,3))
plot(imobiliario$Idade_imovel, imobiliario$Mil_reais_m2,col = "darkturquoise")
plot(imobiliario$Distancia_metro_Km, imobiliario$Mil_reais_m2,col = "darkturquoise")
plot(imobiliario$Comercios_proximos, imobiliario$Mil_reais_m2,col = "darkturquoise")
```


### Segmentação
```{r}
novos <- subset(imobiliario,imobiliario$Idade_imovel <=  25)
antigos <- subset(imobiliario,imobiliario$Idade_imovel > 25)
```


### Imóveis Novos
```{r}
regressao_novos <- lm(data = novos,
                Mil_reais_m2 ~ 
                  Idade_imovel + Distancia_metro_Km + 
                  Comercios_proximos)
summary(regressao_novos)

residuo_novos <- residuals(regressao_novos) 
predito_novos <- fitted.values(regressao_novos)

par(mfrow = c(1,3))
plot(predito_novos, residuo_novos, main = 'Residuos x Valores ajustados - Novos', ylab = 'Residuos', col = "darkturquoise")
hist(residuo_novos, col = "darkturquoise")
qqnorm(residuo_novos, pch = 1, col = "darkturquoise", frame = FALSE)
qqline(residuo_novos, col = "steelblue", lwd = 2)

residuo_novos <- residuals(regressao_novos) 
predito_novos <- fitted.values(regressao_novos)
```


### Imóveis Antigos
```{r}
regressao_antigos <- lm(data = antigos,
                Mil_reais_m2 ~ 
                  Idade_imovel + Distancia_metro_Km + 
                  Comercios_proximos)
summary(regressao_antigos)

residuo_antigos <- residuals(regressao_antigos) 
predito_antigos <- fitted.values(regressao_antigos)

par(mfrow = c(1,3))
plot(predito_antigos, residuo_antigos, main = 'Residuos x Valores ajustados - Antigos', ylab = 'Residuos', col = "darkturquoise")
hist(residuo_antigos, col = "darkturquoise")
qqnorm(residuo_antigos, pch = 1, col = "darkturquoise", frame = FALSE)
qqline(residuo_antigos, col = "steelblue", lwd = 2)

residuo_antigos <- residuals(regressao_antigos) 
predito_antigos <- fitted.values(regressao_antigos)
```


### Quantificação do Modelo para Imóveis Novos

```{r }
mape <- mape(actual = novos$Mil_reais_m2, predicted = predito_novos) # Soma dos quadrados dos residuos
sse <- sse(actual = novos$Mil_reais_m2, predicted = predito_novos) # Avalia a média absoluta dos resíudos, rem relação ao valor original da resposta y
```
#### MAPE: `r format(round(mape, 4), nsmall = 4)`%
#### SSE: `r format(round(sse, 4), nsmall = 4)`

### Quantificação do Modelo para Imóveis Antigos
```{r}
mape <- mape(actual = antigos$Mil_reais_m2, predicted = predito_antigos) # Soma dos quadrados dos residuos
sse <- sse(actual = antigos$Mil_reais_m2, predicted = predito_antigos) # Avalia a média absoluta dos resíudos, rem relação ao valor original da resposta y
```
#### MAPE: `r format(round(mape, 4), nsmall = 4)`%
#### SSE: `r format(round(sse, 4), nsmall = 4)`
