---
title: "Modelagem de Avaliação de Risco para Crédito Imobiliário"
author: "Marcio Cruz"
date: "22/08/2021"
output: html_document
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# inicialização -----------------------------------------------------------
wd <- Sys.getenv("RWD")

if (!file.exists(wd)) {
  stop(paste("O diretorio definido na variavel de ambiente RWD nao foi encontrado",wd, sep="="))
} 

setwd(wd)
getwd()

rm(list = ls())

options(scipen=999)
options(width = 1024)

library(Metrics)
library(MLmetrics)
library("stringi")
library(knitr)
library(InformationValue)
library(moments)
library(pander)
library(dplyr)
library(cutpointr)
library(Information)
library(readxl) #Avisar o R que utilizará este pacote. Deve-se avisar toda vez que abrir o R
library(HH)
library(expss)
library(arules)
library(smbinning)
library(scorecard)
library(ggplot2)
library(ggpubr)
theme_set(theme_pubr())

```

# Case
A base CREDITO IMOBILIARIO.xlsx é compostas por dados de centenas de milhares de financiamentos imobiliários feitos por clientes americanos, trazendo informações sobre as propostas, como dados sócio-demográficos, perfil do financiamento e características do cliente. O objetivo principal em se trabalhar com essa base é desenhar um modelo de predição de inadimplência no pagamento das parcelas do crédito imobiliário. Avalie os seguintes itens:
**Fonte:** Adaptado de https://www.kaggle.com/c/home-credit-default-risk/data

```{r echo = F}
imobiliario_ams <- read_excel("doc/CREDITO IMOBILIARIO - Amostra.xlsx", sheet="Amostra")

colnames(imobiliario_ams) = c("ID Cliente", "Inadimplente", "Tipo Contrato", "Sexo", "Tem Carro",
                              "Tem Casa", "Filhos", "Renda", "Volume Financiamento", "Valor Anual Parcelas", "Acompanhante Cliente",
                              "Tipo Renda", "Estado Civil", "Tipo Residência",  "População Região", "Tem Celular", "Tem Tel Comercial",
                              "Celular Sinal", "Tem Email", "Membros Familia", "Rating Região Moradia", "Dia Semana Proposta", "Hora Proposta", 
                              "Endereço Contato Correto", "Endereço Trabalho Correto")



df_inadimplentes <- imobiliario_ams[imobiliario_ams$Inadimplente == 1,]
df_adimplentes <- imobiliario_ams[imobiliario_ams$Inadimplente == 0,]

```

```{r echo = F}

meuhist <- function(valores, caption_variavel, cor) {
  
barplot(valores, main = caption_variavel, ylab = "Frequência")
}
  
minha_distribuicao <- function(nome_variavel, inicio_caption_variavel, caption_variavel, cor) {
  
  labels <- c()
  for (i in 1:dim(table(nome_variavel))) {
    auxiliar <- substring(rownames(table(nome_variavel))[i], inicio_caption_variavel, stri_length(rownames(table(nome_variavel))[i]))
    auxiliar2 <- paste(table(nome_variavel)[i])
    auxiliar3 <- round(prop.table(table(nome_variavel))[i]*100, 4)

    labels <- append(labels, paste(auxiliar, auxiliar3, '%'))
  }
  
  pie(table(nome_variavel),
      clockwise = T,
      main =  caption_variavel,
      labels = labels)
  
}
  
```


## a) Faça a análise exploratória univariada e bivariada Qual o % de clientes inadimplentes na base?

### % Clientes Inadimplentes x Adimplentes
```{r echo = F}
tabela <- cbind(table(imobiliario_ams$Inadimplente), prop.table(table(imobiliario_ams$Inadimplente)))
colnames(tabela) <- c("Quantidade", "%") 
rownames(tabela) <- c("Adimplente", "Inadimplente")
kable(tabela)
```

### Análise Univariada
#### Sumário das variáveis quantitativas de Inadimplentes
```{r echo = F}
# 
dfauxiliar <-subset(df_inadimplentes, select = c("Renda", "Volume Financiamento", "Valor Anual Parcelas", "População Região", "Membros Familia", "Filhos"))
summary(dfauxiliar)
```

#### Sumário das variáveis quantitativas de Adimplentes
```{r echo = F}
# 
dfauxiliar <-subset(df_adimplentes, select = c("Renda", "Volume Financiamento", "Valor Anual Parcelas", "População Região", "Membros Familia", "Filhos"))
summary(dfauxiliar)
```

#### Conclusão: Não podemos tirar nenhuma conclusão observando as diferenças de valores de variáveis quantitativas entre inadimplentes e adimplentes, já que os valores são bem próximos.


### Variáveis Qualitativas entre Inadimplentes e Inadimplentes
```{r echo = F}
char <- unlist(lapply(imobiliario_ams, is.character)) #seleciona as variaveis char
#loop para tabela de todas as variaveis char

quali_inadimplentes <- df_inadimplentes[ , char]
quali_adimplentes <- df_adimplentes[ , char]

names <- names(quali_inadimplentes) #salva os nomes das variaveis em um vetor

for (i in names) {
  meuhist(table(quali_inadimplentes[,i]), paste(i," - Inadimplentes"), "red")
  minha_distribuicao(quali_inadimplentes[,i], 1, paste0(i," - Inadimplentes"), "red")

  meuhist(table(quali_adimplentes[,i]), paste(i," - Adimplentes"), "blue")
  minha_distribuicao(quali_adimplentes[,i], 1, paste0(i," - Adimplentes"), "blue")
}

```


#### Conclusão: Analisando graficamente através de histograma e gráfico de pizza, percebe-se a influência de algumas variáveis qualitativas, como segue:
#### Tipo de Contrato
#### Sexo
#### Carro
#### Tipo Renda
#### Estado Civil
#### Tipo Residência
#### Dia da Semana que foi feita a proposta



